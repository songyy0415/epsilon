name: CI Poincare junior
on:
  pull_request:
    paths-ignore:
      - '**/*.md'
      - 'poincare/doc/**'
      - 'tests/**'

env:
  MAKEFLAGS: ${{ (github.repository == 'numworks/epsilon-internal') && '-j32 CCACHE=1' || '-j2' }}
  CCACHE_DIR: ${{ (github.repository == 'numworks/epsilon-internal') && '/home/usain/_work/ccache' || '' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    runs-on: ${{ (github.repository == 'numworks/epsilon-internal') && 'with-cache' || 'ubuntu-latest' }}
    steps:
      - uses: numworks/setup-llvm@latest
      - run: echo "LD_LIBRARY_PATH=$LLVM_PATH/lib/x86_64-unknown-linux-gnu/" >> $GITHUB_ENV
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          submodules: ${{ secrets.PAT != null }}
      - run: build/setup.sh --only-simulator
      # TODO_PCJ: Add ASAN=1 and TIDY=1
      - run: make TOOLCHAIN=host-clang PLATFORM=simulator ASSERTIONS=1 epsilon.bin test.bin
      # TODO_PCJ: Uncomment all filters, delete this workflow and re-activate ci.yml once they all run.
      # - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f calculation
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f calculation_store
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f code
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f distributions
      # - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f escher
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f finance
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f graph
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f ion
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f kandinsky
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f liba
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f omg
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f pcj
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f poincare
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f probability
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f python
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f regression
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f sequence
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f shared
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f solver
      - run: output/debug/optimized/linux/test.bin --headless --limit-stack-usage -f statistics
  poincarejs:
    runs-on: ${{ (github.repository == 'numworks/epsilon-internal') && 'with-cache' || 'ubuntu-latest' }}
    steps:
      - uses: numworks/setup-emscripten@latest
        with:
          sdk: 3.1.61
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          submodules: ${{ secrets.PAT != null }}
      - run: build/setup.sh --only-simulator
      # TODO: Change setup-emscripten to be able to use EMIT_TSD=1
      - run: make -j8 -f poincare/Makefile PLATFORM=foxglove ASSERTIONS=1 EMIT_TSD=0 poincare.js.run
