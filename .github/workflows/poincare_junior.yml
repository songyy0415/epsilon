name: CI Poincare junior
on:
  pull_request:
    branches:
      - poincare-junior
env:
  MAKEFLAGS: ${{ endswith(github.repository, '/epsilon-internal') && '-j32' || '-j2' }} ${{ (github.job == 'device') && 'EMBED_EXTRA_DATA=1' }}

jobs:
  device:
    runs-on: ${{ endswith(github.repository, '/epsilon-internal') && 'self-hosted' || 'ubuntu-latest' }}
    strategy:
      matrix:
        model: [n0110]
    steps:
      - uses: numworks/setup-arm-toolchain@latest
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT || github.token }}
          submodules: ${{ secrets.PAT != null }}
      - run: build/setup.sh
      - name: Check for epsilon-core
        id: epsilon-core
        run: "[[ -e ion/src/device/epsilon-core/.gitignore ]]"
        continue-on-error: true
      - name: Build userlands
        run: make MODEL=${{ matrix.model }} userland.A.elf
  linux:
    runs-on: ${{ endswith(github.repository, '/epsilon-internal') && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - uses: numworks/setup-llvm@latest
      - uses: actions/checkout@v3
      - run: build/setup.sh --only-simulator
      - run: make TOOLCHAIN=host-clang PLATFORM=simulator ASSERTIONS=1 test.bin
        # TODO this LD_LIBRARY_PATH is quite dirty
      - run: LD_LIBRARY_PATH=/home/usain/_work/_tool/llvm/15.0.6/x64/lib/x86_64-unknown-linux-gnu/ output/release/simulator/linux/test.bin --headless --limit-stack-usage
